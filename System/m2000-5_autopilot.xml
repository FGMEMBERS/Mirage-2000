<?xml version="1.0" encoding="iso-8859-1"?>

<PropertyList>
  <!-- There is a large flaw in FG's standard pid-controller which
       keeps it from working when the reference changes suddendly. The
       controllers below are implemented by combining a gain filter
       with integrator and derivative filters (using a final gain
       filter to sum them)

       The two following filters allow mixing values depending on
       speed so that one value will be chosen at speeds below 400 kts,
       another value will be chosen at speeds above 600 kts and
       intermediate values will be chosen in between.
  -->
  <filter>
    <name>high-speed-weight</name>
    <type>gain</type>
    <input><expression><table>
      <property>/velocities/airspeed-kt</property>
      <entry><ind>400</ind><dep>0.0</dep></entry>
      <entry><ind>600</ind><dep>1.0</dep></entry>
    </table></expression></input>
    <output>/autopilot/internal/speed-weight-high</output>
    <value>0.0</value>
    <gain>1</gain>
  </filter>

  <filter>
    <name>speed-weight-low</name>
    <type>gain</type>
    <input>/autopilot/internal/speed-weight-high</input>
    <reference>1</reference>
    <output>/autopilot/internal/speed-weight-low</output>
    <gain>1</gain>
  </filter>

  <!-- =============================================================== -->
  <!-- Lateral Modes                                                   -->
  <!-- =============================================================== -->

  <!-- PID controller that sets the aileron trim to follow a
       reference roll when AP-status is AP1.

       Input:     /orientation/roll-deg
       Reference: /autopilot/settings/target-roll-deg
       Internals: /autopilot/internal/aileron-pid/*
       Condition: /autopilot/locks/AP-status == "AP1"
       Output:    /controls/flight/aileron-trim

       At 200 kts, 5000 ft:
       Ku: 1.55
       Fu: 1.58 Hz

       At 700 kts, 40000 ft:
       Ku: 0.64
       Fu: 8.28 Hz

       At 850 kts, 20000 ft:
       Ku: 0.09
       Fu: 4.59 Hz
  -->
  <filter>
    <name>aileron-pid/Kp</name>
    <type>gain</type>
    <reference><expression><product>
      <property>/autopilot/internal/aileron-pid/kp-low</property>
      <property>/autopilot/internal/speed-weight-low</property>
    </product></expression></reference>
    <input><expression><product>
      <property>/autopilot/internal/aileron-pid/kp-high</property>
      <property>/autopilot/internal/speed-weight-high</property>
    </product></expression></input>
    <output>/autopilot/internal/aileron-pid/kp</output>
    <gain>1</gain>
  </filter>

  <filter>
    <name>aileron-pid/Ki</name>
    <type>gain</type>
    <reference><expression><product>
      <property>/autopilot/internal/aileron-pid/ki-low</property>
      <property>/autopilot/internal/speed-weight-low</property>
    </product></expression></reference>
    <input><expression><product>
      <property>/autopilot/internal/aileron-pid/ki-high</property>
      <property>/autopilot/internal/speed-weight-high</property>
    </product></expression></input>
    <output>/autopilot/internal/aileron-pid/ki</output>
    <gain>1</gain>
  </filter>

  <filter>
    <name>aileron-pid/Kd</name>
    <type>gain</type>
    <reference><expression><product>
      <property>/autopilot/internal/aileron-pid/kd-low</property>
      <property>/autopilot/internal/speed-weight-low</property>
    </product></expression></reference>
    <input><expression><product>
      <property>/autopilot/internal/aileron-pid/kd-high</property>
      <property>/autopilot/internal/speed-weight-high</property>
    </product></expression></input>
    <output>/autopilot/internal/aileron-pid/kd</output>
    <gain>1</gain>
  </filter>

  <filter>
    <name>aileron-pid/P</name>
    <type>gain</type>
    <input>/orientation/roll-deg</input>
    <reference>/autopilot/settings/target-roll-deg</reference>
    <output>/autopilot/internal/aileron-pid/p-output</output>
    <gain>/autopilot/internal/aileron-pid/kp</gain>
  </filter>

  <filter>
    <name>aileron-pid/I</name>
    <type>integrator</type>
    <input>
      <property>/orientation/roll-deg</property>
      <condition>
        <equals>
          <property>/autopilot/locks/AP-status</property>
          <value>AP1</value>
        </equals>
      </condition>
    </input>
    <input>
      <!-- This causes the integrator to reset when AP is disabled -->
      <expression>
        <sum>
          <property>/autopilot/settings/target-roll-deg</property>
          <product>
            <value>-100.0</value>
            <property>/autopilot/internal/aileron-pid/i-output</property>
          </product>
        </sum>
      </expression>
    </input>
    <reference>/autopilot/settings/target-roll-deg</reference>
    <output>/autopilot/internal/aileron-pid/i-output</output>
    <initialize-to>input</initialize-to>
    <gain>/autopilot/internal/aileron-pid/ki</gain>
    <u_min>-1.0</u_min>
    <u_max>1.0</u_max>
  </filter>

  <filter>
    <name>aileron-pid/D</name>
    <type>derivative</type>
    <input>/orientation/roll-deg</input>
    <reference>/autopilot/settings/target-roll-deg</reference>
    <output>/autopilot/internal/aileron-pid/d-output</output>
    <filter-time>/autopilot/internal/aileron-pid/kd</filter-time>
  </filter>

  <filter>
    <name>aileron-pid</name>
    <type>gain</type>
    <enable>
      <property>/autopilot/locks/AP-status</property>
      <value>AP1</value>
    </enable>
    <input>0.0</input>
    <reference><expression><sum>
      <property>/autopilot/internal/aileron-pid/p-output</property>
      <property>/autopilot/internal/aileron-pid/i-output</property>
      <property>/autopilot/internal/aileron-pid/d-output</property>
    </sum></expression></reference>
    <output>/controls/flight/aileron-trim</output>
    <min>-1.0</min>
    <max>1.0</max>
  </filter>

  <!-- P controller that sets the target roll to follow a given
       heading when AP is in heading mode.

       Note that the input is selected dynamically depending on the
       mode (Heading bug or NAV) and source.

       Input:     /autopilot/internal/target-heading-p/course-offset
       Reference: 0.0
       Internals: /autopilot/internal/target-heading-p/*
       Condition: /autopilot/locks/heading == "AP1"
       Output:    /autopilot/settings/target-roll-deg

       At 200 kts, 5000 ft:
       Ku: 28
       Fu: 12 Hz

       At 500 kts, 20000 ft:
       Ku: 6.8
       Fu: 4.6 Hz
  -->
  <filter><!-- Select the appropriate NAV reference -->
    <name>target-heading-p/Course-offset</name>
    <type>gain</type>

    <input>
      <property>/instrumentation/nav[0]/radials/selected-deg</property>
      <condition><equals>
        <property>/autopilot/settings/nav-source</property>
        <value>NAV1</value>
      </equals></condition>
    </input>
    <input>
      <property>/instrumentation/nav[1]/radials/selected-deg</property>
      <condition><equals>
        <property>/autopilot/settings/nav-source</property>
        <value>NAV2</value>
      </equals></condition>
    </input>
    <input>
      <property>/instrumentation/tacan/indicated-bearing-true-deg</property>
      <condition><equals>
        <property>/autopilot/settings/nav-source</property>
        <value>TACAN</value>
      </equals></condition>
    </input>
    <input>
      <property>/autopilot/route-manager/wp/bearing-deg</property>
      <condition><equals>
        <property>/autopilot/settings/nav-source</property>
        <value>FMS</value>
      </equals></condition>
    </input>

    <reference><expression><difference>
      <property>/orientation/heading-magnetic-deg</property>
      <property>/autopilot/internal/cdi</property>
    </difference></expression></reference>
    <output>/autopilot/internal/target-heading-p/course-offset</output>
    <period><min>-180</min><max>180</max></period>
  </filter>

  <filter>
    <name>target-heading-p/Input</name>
    <type>gain</type>
    <input>
      <property>/autopilot/internal/target-heading-p/course-offset</property>
      <condition><or>
        <equals>
          <property>autopilot/locks/heading</property>
          <value>VOR</value>
        </equals>
        <equals>
          <property>autopilot/locks/heading</property>
          <value>LOC</value>
        </equals>
        <equals>
          <property>autopilot/locks/heading</property>
          <value>LNAV</value>
        </equals>
      </or></condition>
    </input>
    <input>/autopilot/internal/heading-bug-error-deg</input>
    <output>/autopilot/internal/target-heading-p/target-heading-error-deg</output>
    <gain>-1</gain>
  </filter>

  <filter>
    <name>target-heading-p/P</name>
    <type>gain</type>
    <enable><condition><or>
      <equals>
        <property>autopilot/locks/heading</property>
        <value>VOR</value>
      </equals>
      <equals>
        <property>autopilot/locks/heading</property>
        <value>LOC</value>
      </equals>
      <equals>
        <property>autopilot/locks/heading</property>
        <value>LNAV</value>
      </equals>
      <equals>
        <property>/autopilot/locks/heading</property>
        <value>HDG</value>
      </equals>
    </or></condition></enable>
    <input>0.0</input>
    <reference>/autopilot/internal/target-heading-p/target-heading-error-deg</reference>
    <output>/autopilot/settings/target-roll-deg</output>
    <gain>
      <property>/autopilot/internal/target-heading-p/kp</property>
      <value>3.4</value>
    </gain>
    <min>
      <property>/autopilot/settings/bank-limit</property>
      <scale>-1</scale>
    </min>
    <max>
      <property>/autopilot/settings/bank-limit</property>
    </max>
  </filter>

  <!-- =============================================================== -->
  <!-- Vertical Modes                                                  -->
  <!-- =============================================================== -->

  <!-- PID controller that sets the elevator trim to follow a
       reference pitch when AP-status is AP1.

       Input:     /orientation/pitch-deg
       Reference: /autopilot/settings/target-pitch-deg
       Internals: /autopilot/internal/target-pitch-pid/*
       Condition: /autopilot/locks/AP-status == "AP1"
       Output:    /controls/flight/elevator-trim

       At 200 kts, 5000 ft:
       Ku: 3.5
       Fu: 3.1 Hz

       At 700 kts, 40000 ft:
       Ku: 0.8
       Fu: 6.2 Hz

       At 850 kts, 20000 ft:
       Ku: 0.054
       Fu: 3.05 Hz
  -->
  <filter>
    <name>target-pitch-pid/Kp</name>
    <type>gain</type>
    <reference><expression><product>
      <property>/autopilot/internal/target-pitch-pid/kp-low</property>
      <property>/autopilot/internal/speed-weight-low</property>
    </product></expression></reference>
    <input><expression><product>
      <property>/autopilot/internal/target-pitch-pid/kp-high</property>
      <property>/autopilot/internal/speed-weight-high</property>
    </product></expression></input>
    <output>/autopilot/internal/target-pitch-pid/kp</output>
    <gain>1</gain>
  </filter>

  <filter>
    <name>target-pitch-pid/Ki</name>
    <type>gain</type>
    <reference><expression><product>
      <property>/autopilot/internal/target-pitch-pid/ki-low</property>
      <property>/autopilot/internal/speed-weight-low</property>
    </product></expression></reference>
    <input><expression><product>
      <property>/autopilot/internal/target-pitch-pid/ki-high</property>
      <property>/autopilot/internal/speed-weight-high</property>
    </product></expression></input>
    <output>/autopilot/internal/target-pitch-pid/ki</output>
    <gain>1</gain>
  </filter>

  <filter>
    <name>target-pitch-pid/Kd</name>
    <type>gain</type>
    <reference><expression><product>
      <property>/autopilot/internal/target-pitch-pid/kd-low</property>
      <property>/autopilot/internal/speed-weight-low</property>
    </product></expression></reference>
    <input><expression><product>
      <property>/autopilot/internal/target-pitch-pid/kd-high</property>
      <property>/autopilot/internal/speed-weight-high</property>
    </product></expression></input>
    <output>/autopilot/internal/target-pitch-pid/kd</output>
    <gain>1</gain>
  </filter>

  <filter>
    <name>target-pitch-pid/P</name>
    <type>gain</type>
    <input>/orientation/pitch-deg</input>
    <reference>/autopilot/settings/target-pitch-deg</reference>
    <output>/autopilot/internal/target-pitch-pid/p-output</output>
    <gain>/autopilot/internal/target-pitch-pid/kp</gain>
  </filter>

  <filter>
    <name>target-pitch-pid/I</name>
    <type>integrator</type>
    <input>
      <property>/orientation/pitch-deg</property>
      <condition>
        <equals>
          <property>/autopilot/locks/AP-status</property>
          <value>AP1</value>
        </equals>
      </condition>
    </input>
    <input>
      <!-- This causes the integrator to reset when AP is disabled -->
      <expression>
        <sum>
          <property>/autopilot/settings/target-pitch-deg</property>
          <product>
            <value>-100.0</value>
            <property>/autopilot/internal/target-pitch-pid/i-output</property>
          </product>
        </sum>
      </expression>
    </input>
    <reference>/autopilot/settings/target-pitch-deg</reference>
    <output>/autopilot/internal/target-pitch-pid/i-output</output>
    <initialize-to>input</initialize-to>
    <gain>/autopilot/internal/target-pitch-pid/ki</gain>
    <u_min>-1.0</u_min>
    <u_max>1.0</u_max>
  </filter>

  <filter>
    <name>target-pitch-pid/D</name>
    <type>derivative</type>
    <input>/orientation/pitch-deg</input>
    <reference>/autopilot/settings/target-pitch-deg</reference>
    <output>/autopilot/internal/target-pitch-pid/d-output</output>
    <filter-time>/autopilot/internal/target-pitch-pid/kd</filter-time>
  </filter>

  <filter>
    <name>target-pitch-pid</name>
    <type>gain</type>
    <enable>
      <property>/autopilot/locks/AP-status</property>
      <value>AP1</value>
    </enable>
    <input><expression><sum>
      <property>/autopilot/internal/target-pitch-pid/p-output</property>
      <property>/autopilot/internal/target-pitch-pid/i-output</property>
      <property>/autopilot/internal/target-pitch-pid/d-output</property>
    </sum></expression></input>
    <output>/controls/flight/elevator-trim</output>
    <min>-1.0</min>
    <max>1.0</max>
  </filter>

  <!-- PID controller that sets the target vertical speed to maintain
       altitude when AP-status is ALT or TF. Note that it would be
       theoretically possible to maintain altitude by controlling the
       pitch directly, but this proved unreliable at low speed: the
       controller was unable to keep enough positive pitch to maintain
       altitude.

       Input:     /instrumentation/altimeter/indicated-altitude-ft
       Reference: /autopilot/settings/target-altitude-ft (ALT)
       Reference: /autopilot/internal/altitude-pid/tf-altitude-offset-ft (TF)
       Internals: /autopilot/internal/altitude-pid/*
       Condition: /autopilot/locks/altitude == "ALT" or
                  /autopilot/locks/altitude == "TF"
       Output:    /autopilot/settings/vertical-speed-fpm

       Ku: 140
       Fu: 0.22 Hz
  -->
  <logic>
    <input><equals>
      <property>/autopilot/locks/altitude</property>
      <value>ALT</value>
    </equals></input>
    <output>/autopilot/internal/altitude-pid/mode-alt</output>
  </logic>
  <logic>
    <input><equals>
      <property>/autopilot/locks/altitude</property>
      <value>TF</value>
    </equals></input>
    <output>/autopilot/internal/altitude-pid/mode-tf</output>
  </logic>
  <logic>
    <input><or>
      <property>/autopilot/internal/altitude-pid/mode-alt</property>
      <property>/autopilot/internal/altitude-pid/mode-tf</property>
    </or></input>
    <output>/autopilot/internal/altitude-pid/enabled</output>
  </logic>

  <filter>
    <name>altitude-pid/TFS</name>
    <type>moving-average</type>
    <samples><expression><product>
      <value>120</value> <!-- Assumes that the simulation runs at 120Hz -->
      <property>/autopilot/settings/tf-mode</property>
    </product></expression></samples>
    <input>/position/altitude-ft</input>
    <reference>/instrumentation/tfs/ground-altitude-ft</reference>
    <output>/autopilot/internal/altitude-pid/tf-altitude-offset-ft</output>
  </filter>

  <filter>
    <!-- This LP filter is needed to smooth some noise in the
      indicated altitude that causes the D controller to give
      spurious results. -->
    <name>altitude-pid/LP</name>
    <type>exponential</type>
    <input>
      <property>/instrumentation/altimeter/indicated-altitude-ft</property>
      <condition><property>/autopilot/internal/altitude-pid/mode-alt</property></condition>
    </input>
    <input>
      <property>/autopilot/internal/altitude-pid/tf-altitude-offset-ft</property>
      <condition><property>/autopilot/internal/altitude-pid/mode-tf</property></condition>
    </input>
    <output>/autopilot/internal/altitude-pid/lp-output</output>
    <filter-time>0.16</filter-time>
  </filter>

  <filter>
    <name>altitude-pid/P</name>
    <type>gain</type>
    <input>/autopilot/internal/altitude-pid/lp-output</input>
    <reference>/autopilot/settings/target-altitude-ft</reference>
    <output>/autopilot/internal/altitude-pid/p-output</output>
    <gain>
      <property>/autopilot/internal/altitude-pid/kp</property>
      <value>28.0</value>
    </gain>
  </filter>

  <filter>
    <name>altitude-pid/I</name>
    <type>integrator</type>
    <input>
      <property>/autopilot/internal/altitude-pid/lp-output</property>
      <condition><property>/autopilot/internal/altitude-pid/enabled</property></condition>
    </input>
    <input>
      <!-- This causes the integrator to reset when AP is disabled -->
      <expression>
        <sum>
          <property>/autopilot/settings/target-altitude-ft</property>
          <product>
            <value>-100.0</value>
            <property>/autopilot/internal/altitude-pid/i-output</property>
          </product>
        </sum>
      </expression>
    </input>
    <reference>/autopilot/settings/target-altitude-ft</reference>
    <output>/autopilot/internal/altitude-pid/i-output</output>
    <initialize-to>input</initialize-to>
    <gain>
      <property>/autopilot/internal/altitude-pid/ki</property>
      <value>12.32</value>
    </gain>
    <u_min>-100.0</u_min>
    <u_max>100.0</u_max>
  </filter>

  <filter>
    <name>altitude-pid/D</name>
    <type>derivative</type>
    <input>/autopilot/internal/altitude-pid/lp-output</input>
    <reference>/autopilot/settings/target-altitude-ft</reference>
    <output>/autopilot/internal/altitude-pid/d-output</output>
    <filter-time>
      <property>/autopilot/internal/altitude-pid/kd</property>
      <value>42.42</value>
    </filter-time>
  </filter>

  <filter>
    <name>altitude-pid</name>
    <type>gain</type>
    <enable>/autopilot/internal/altitude-pid/enabled</enable>
    <input>0.0</input>
    <reference><expression><sum>
      <property>/autopilot/internal/altitude-pid/p-output</property>
      <property>/autopilot/internal/altitude-pid/i-output</property>
      <property>/autopilot/internal/altitude-pid/d-output</property>
    </sum></expression></reference>
    <output>/autopilot/settings/vertical-speed-fpm</output>
    <!-- Unlimited output, we rely on the pitch control to keep
      reasonable values -->
  </filter>

  <!-- PID controller that sets the target pitch to maintain a given
  vertical speed.

  Input:     /velocities/vertical-speed-fps
  Reference: /autopilot/internal/gs-rate-fps (GS mode)
  Reference: /autopilot/settings/vertical-speed-fpm (VS mode)
  Internals: /autopilot/internal/vertical-speed-pid/*
  Condition: /autopilot/locks/altitude == "GS" (GS mode)
  Condition: /autopilot/locks/altitude == "VS" (VS mode)
  Condition: /autopilot/internal/altitude-pid/enabled (VS mode)
  Output:    /autopilot/settings/target-pitch-deg

  At 200 kts, 5000 ft:
  Ku: 0.67
  Fu: 4.41 Hz

  At 700 kts, 40000 ft:
  Ku: 0.34
  Fu: 2.21 Hz
  Safety margin: 50%

  Note that at high speed, the "standard no overshoot" formula
  still gave unstable results. Hence the 50% safety margin from
  the standard parameters.
  -->
  <logic>
    <input><equals>
      <property>/autopilot/locks/altitude</property>
      <value>GS</value>
    </equals></input>
    <output>/autopilot/internal/vertical-speed-pid/mode-gs</output>
  </logic>
  <logic>
    <input><or>
      <equals>
        <property>/autopilot/locks/altitude</property>
        <value>VS</value>
      </equals>
      <property>/autopilot/internal/altitude-pid/enabled</property>
    </or></input>
    <output>/autopilot/internal/vertical-speed-pid/mode-vs</output>
  </logic>
  <logic>
    <input><or>
      <property>/autopilot/internal/vertical-speed-pid/mode-gs</property>
      <property>/autopilot/internal/vertical-speed-pid/mode-vs</property>
    </or></input>
    <output>/autopilot/internal/vertical-speed-pid/enabled</output>
  </logic>

  <filter>
    <!-- At low speeds, we want to allow higher pitch values to
    compensate for the lowered lift. -->
    <name>vertical-speed-pid/output-limits-offset</name>
    <type>gain</type>
    <input><expression><table>
      <property>/velocities/airspeed-kt</property>
      <entry><ind>150</ind><dep>7.5</dep></entry>
      <entry><ind>400</ind><dep>0.0</dep></entry>
    </table></expression></input>
    <output>/autopilot/internal/vertical-speed-pid/output-limits-offset</output>
    <gain>1</gain>
  </filter>

  <filter>
    <name>vertical-speed-pid/Reference</name>
    <type>gain</type>
    <input>
      <condition>
        <property>/autopilot/internal/vertical-speed-pid/mode-gs</property>
      </condition>
      <property>autopilot/internal/gs-rate-fps</property>
    </input>
    <input>
      <condition>
        <property>/autopilot/internal/vertical-speed-pid/mode-vs</property>
      </condition>
      <property>/autopilot/settings/vertical-speed-fpm</property>
      <scale>0.016667</scale>   <!-- Convert to FPS -->
    </input>
    <input>0.0</input>
    <output>/autopilot/internal/vertical-speed-pid/reference</output>
    <gain>1</gain>
  </filter>

  <filter>
    <!-- This LP filter is needed to smooth some noise in the
    indicated altitude that causes the D controller to give
    spurious results. -->
    <name>vertical-speed-pid/LP</name>
    <type>exponential</type>
    <input>/velocities/vertical-speed-fps</input>
    <output>/autopilot/internal/vertical-speed-pid/input</output>
    <filter-time>0.16</filter-time>
  </filter>

  <filter>
    <name>vertical-speed-pid/P</name>
    <type>gain</type>
    <input>/autopilot/internal/vertical-speed-pid/input</input>
    <reference>/autopilot/internal/vertical-speed-pid/reference</reference>
    <output>/autopilot/internal/vertical-speed-pid/p-output</output>
    <gain>/autopilot/internal/vertical-speed-pid/kp</gain>
  </filter>

  <filter>
    <name>vertical-speed-pid/I</name>
    <type>integrator</type>
    <input>
      <property>/autopilot/internal/vertical-speed-pid/input</property>
      <condition>
        <property>/autopilot/internal/vertical-speed-pid/enabled</property>
      </condition>
    </input>
    <input>
      <!-- This causes the integrator to reset when AP is disabled -->
      <expression><sum>
        <property>/autopilot/internal/vertical-speed-pid/reference</property>
        <product>
          <value>-100.0</value>
          <property>/autopilot/internal/vertical-speed-pid/i-output</property>
        </product>
      </sum></expression>
    </input>
    <reference>/autopilot/internal/vertical-speed-pid/reference</reference>
    <output>/autopilot/internal/vertical-speed-pid/i-output</output>
    <initialize-to>input</initialize-to>
    <gain>/autopilot/internal/vertical-speed-pid/ki</gain>
    <u_min>
      <property>/autopilot/internal/vertical-speed-pid/output-limits-offset</property>
      <scale>-1</scale>
      <offset>-5.0</offset>
    </u_min>
    <u_max>
      <property>/autopilot/internal/vertical-speed-pid/output-limits-offset</property>
      <scale>-1</scale>
      <offset>5.0</offset>
    </u_max>
  </filter>

  <filter>
    <name>vertical-speed-pid/D</name>
    <type>derivative</type>
    <input>/autopilot/internal/vertical-speed-pid/input</input>
    <reference>/autopilot/internal/vertical-speed-pid/reference</reference>
    <output>/autopilot/internal/vertical-speed-pid/d-output</output>
    <filter-time>/autopilot/internal/vertical-speed-pid/kd</filter-time>
  </filter>

  <filter>
    <name>vertical-speed-pid</name>
    <type>gain</type>
    <enable><condition><or>
        <property>/autopilot/internal/vertical-speed-pid/mode-gs</property>
        <property>/autopilot/internal/vertical-speed-pid/mode-vs</property>
    </or></condition></enable>
    <input>0.0</input>
    <reference><expression><sum>
      <property>/autopilot/internal/vertical-speed-pid/p-output</property>
      <property>/autopilot/internal/vertical-speed-pid/i-output</property>
      <property>/autopilot/internal/vertical-speed-pid/d-output</property>
    </sum></expression></reference>
    <output>/autopilot/internal/vertical-speed-pid/output</output>
    <min>-5.0</min> <!-- Note that using output-limits-offset here does not work with ILS nor TF -->
    <max>
      <!-- This allows extra pitch when in TF mode -->
      <condition><property>/autopilot/internal/altitude-pid/mode-tf</property></condition>
      <value>25</value>
    </max>
    <max>
      <property>/autopilot/internal/vertical-speed-pid/output-limits-offset</property>
      <offset>5.0</offset>
    </max>
  </filter>

  <!-- Rate limit filter to avoid violent movements at high speed -->
  <filter>
    <name>vertical-speed-pid/out-filter</name>
    <type>noise-spike</type>
    <enable><condition>
      <property>/autopilot/internal/vertical-speed-pid/enabled</property>
    </condition></enable>
    <input>/autopilot/internal/vertical-speed-pid/output</input>
    <output>/autopilot/settings/target-pitch-deg</output>
    <max-rate-of-change><expression><div>
      <value>3500</value>
      <property>/velocities/airspeed-kt</property>
    </div></expression></max-rate-of-change>
  </filter>

  <!-- Internal Tests  -->
  <filter>
    <name>nav1 heading deflection</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>NAV1</value>
        </equals>
      </condition>
    </enable>
    <input>
      <property>instrumentation/nav/heading-needle-deflection</property>
      <scale>3</scale>
    </input>
    <output>autopilot/internal/cdi</output>
    <type>noise-spike</type>
    <max-rate-of-change>20</max-rate-of-change>
  </filter>

  <filter>
    <name>nav1 gs deflection</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>NAV1</value>
        </equals>
      </condition>
    </enable>
    <input>
      <property>instrumentation/nav/gs-needle-deflection-norm</property>
    </input>
    <output>autopilot/internal/gs-deflection</output>
    <type>noise-spike</type>
    <max-rate-of-change>1</max-rate-of-change>
  </filter>

  <filter>
    <name>nav1 gs drate</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>NAV1</value>
        </equals>
      </condition>
    </enable>
    <input>
      <property>instrumentation/nav/gs-rate-of-climb</property>
    </input>
    <output>autopilot/internal/gs-rate-fps</output>
    <type>noise-spike</type>
    <max-rate-of-change>10</max-rate-of-change>
  </filter>

  <filter>
    <name>nav2 heading deflection</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>NAV2</value>
        </equals>
      </condition>
    </enable>
    <input>
      <property>instrumentation/nav[1]/heading-needle-deflection</property>
      <scale>4.5</scale>
    </input>
    <output>autopilot/internal/cdi</output>
    <type>noise-spike</type>
    <max-rate-of-change>10</max-rate-of-change>
  </filter>

  <filter>
    <name>nav2 gs deflection</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>NAV2</value>
        </equals>
      </condition>
    </enable>
    <input>
      <property>instrumentation/nav[1]/gs-needle-deflection-norm</property>
    </input>
    <output>autopilot/internal/gs-deflection</output>
    <type>noise-spike</type>
    <max-rate-of-change>1</max-rate-of-change>
  </filter>

  <filter>
    <name>nav2 gs rate</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>NAV2</value>
        </equals>
      </condition>
    </enable>
    <input>
      <property>instrumentation/nav[1]/gs-rate-of-climb</property>
    </input>
    <output>autopilot/internal/gs-rate-fps</output>
    <type>noise-spike</type>
    <max-rate-of-change>10</max-rate-of-change>
  </filter>

  <filter>
    <name>fms heading deflection</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>FMS</value>
        </equals>
      </condition>
    </enable>
    <input>
      <property>instrumentation/gps/wp/wp[1]/course-error-nm</property>
      <scale>9.0</scale>
    </input>
    <output>autopilot/internal/cdi</output>
    <type>noise-spike</type>
    <max-rate-of-change>10</max-rate-of-change>
  </filter>

  <filter>
    <name>fms gs deflection</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>FMS</value>
        </equals>
      </condition>
    </enable>
    <input>
      <value>0</value>
    </input>
    <output>autopilot/internal/gs-rate-fps</output>
    <type>noise-spike</type>
    <max-rate-of-change>1</max-rate-of-change>
  </filter>

  <filter>
    <name>vnav alt</name>
    <debug>false</debug>
    <feedback-if-disabled>true</feedback-if-disabled>
    <initialize-to>output</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>autopilot/settings/nav-source</property>
          <value>FMS</value>
        </equals>
      </condition>
    </enable>
    <input>instrumentation/gps/wp/wp[1]/altitude-ft</input>
    <output>autopilot/settings/vnav-alt</output>
    <type>noise-spike</type>
    <max-rate-of-change>500</max-rate-of-change>
  </filter>

  <pi-simple-controller>
    <name>NAV1 bearing</name>
    <debug>false</debug>
    <enable>
      <prop>/instrumentation/primus2000/sc840/nav1ptr</prop>
      <value>1</value>
    </enable>
    <input>
      <prop>orientation/heading-deg</prop>
    </input>
    <reference>
      <prop>instrumentation/nav/heading-deg</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/nav1-pointer</prop>
    </output>
    <config>
      <Kp>1</Kp>
      <Ki>0.0</Ki>
      <min>-360</min>
      <max>360.0</max>
    </config>
  </pi-simple-controller>

  <filter>
    <name>ADF1 pointer</name>
    <debug>false</debug>
    <feedback-if-disabled>false</feedback-if-disabled>
    <initialize-to>input</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>/instrumentation/primus2000/sc840/nav1ptr</property>
          <value>2</value>
        </equals>
      </condition>
    </enable>
    <input>instrumentation/adf/indicated-bearing-deg</input>
    <output>/autopilot/internal/nav1-pointer</output>
    <type>noise-spike</type>
    <max-rate-of-change>90</max-rate-of-change>
  </filter>

  <pi-simple-controller>
    <name>FMS1 bearing</name>
    <debug>false</debug>
    <enable>
      <prop>/instrumentation/primus2000/sc840/nav1ptr</prop>
      <value>3</value>
    </enable>
    <input>
      <prop>orientation/heading-magnetic-deg</prop>
    </input>
    <reference>
      <prop>instrumentation/gps/wp/wp[1]/bearing-mag-deg</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/nav1-pointer</prop>
    </output>
    <config>
      <Kp>1</Kp>
      <Ki>0.01</Ki>
      <min>-360</min>
      <max>360.0</max>
    </config>
  </pi-simple-controller>

  <pi-simple-controller>
    <name>NAV2 bearing</name>
    <debug>false</debug>
    <enable>
      <prop>/instrumentation/primus2000/sc840/nav2ptr</prop>
      <value>1</value>
    </enable>
    <input>
      <prop>orientation/heading-deg</prop>
    </input>
    <reference>
      <prop>instrumentation/nav[1]/heading-deg</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/nav2-pointer</prop>
    </output>
    <config>
      <Kp>1</Kp>
      <Ki>0.0</Ki>
      <min>-360</min>
      <max>360.0</max>
    </config>
  </pi-simple-controller>

  <filter>
    <name>ADF2 pointer</name>
    <debug>false</debug>
    <feedback-if-disabled>false</feedback-if-disabled>
    <initialize-to>input</initialize-to>
    <enable>
      <condition>
        <equals>
          <property>/instrumentation/primus2000/sc840/nav2ptr</property>
          <value>2</value>
        </equals>
      </condition>
    </enable>
    <input>instrumentation/adf[1]/indicated-bearing-deg</input>
    <output>/autopilot/internal/nav2-pointer</output>
    <type>noise-spike</type>
    <max-rate-of-change>90</max-rate-of-change>
  </filter>

  <pi-simple-controller>
    <name>FMS2 bearing</name>
    <debug>false</debug>
    <enable>
      <prop>/instrumentation/primus2000/sc840/nav2ptr</prop>
      <value>3</value>
    </enable>
    <input>
      <prop>orientation/heading-magnetic-deg</prop>
    </input>
    <reference>
      <prop>instrumentation/gps/wp/wp[1]/bearing-mag-deg</prop>
    </reference>
    <output>
      <prop>/autopilot/internal/nav2-pointer</prop>
    </output>
    <config>
      <Kp>1</Kp>
      <Ki>0.01</Ki>
      <min>-360</min>
      <max>360.0</max>
    </config>
  </pi-simple-controller>

  <!-- =============================================================== -->
  <!-- Velocity Modes                                                  -->
  <!-- =============================================================== -->

  <!-- Auto throttle -->
  <pid-controller>
    <name>Auto Throttle (5 sec lookahead)</name>
    <debug>false</debug>
    <enable>
      <prop>/autopilot/locks/speed</prop>
      <value>SPD</value>
    </enable>
    <input>
      <prop>/autopilot/internal/lookahead-5-sec-airspeed-kt</prop>
      <prop>/velocities/airspeed-kt</prop>
    </input>
    <reference>
      <prop>/autopilot/settings/target-speed-kt</prop>
    </reference>
    <output>
      <prop>/controls/engines/engine[0]/throttle</prop>
    </output>
    <config>
      <Kp>0.06</Kp>
      <beta>1.0</beta>
      <alpha>0.1</alpha>
      <gamma>0.0</gamma>
      <Ti>3.2</Ti>
      <Td>0.8</Td>
      <u_min>0.0</u_min>
      <u_max>0.8</u_max>        <!-- Limit to 80% (ie. not afterburners) -->
    </config>
  </pid-controller>

</PropertyList>
